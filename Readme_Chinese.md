# SamGraph 部署与使用手册

袁加熠 yuanjy17@mails.tsinghua.edu.cn

## SamGraph简介

SamGraph是一个高效的、可扩展的、用户友好的基于采样的近似图挖掘系统。SamGraph以C++进行编写，搭建在以MPI为底层通信接口，以Pthreads为硬件线程接口的多机环境中，是结合了误差和估计算法的近似图挖掘系统。该系统以数理统计为理论基础，应用了以点为中心的多机采样、结果估计的方法。同时，该系统具有极强的可扩展性，可应用于任意节点数量的分布式系统中，也可应用于极大的数据上。

## SamGraph部署结构与工作流程

SamGraph具有核心节点、计算节点和存储节点、它们分别部署在不同的机器/或硬件线程上。具体来说，核心节点和计算节点不涉及多个进程，使用单一计算线程即可。存储节点会开辟多个线程进行采样。

启动阶段，首先由核心节点确定由用户提供的数据集、任务、以及误差置信度等信息，确定计算节点和存储节点的个数，存储节点从外存中读入数据集。

运行时，核心节点和计算节点通信，循环发送/接收计算任务。计算节点在接收到计算任务后，随机分配采样任务到各个存储节点，收集齐存储节点发来的采样子图后，合并并进行具体图挖掘计算，获得结果发回给计算节点。存储节点则循环接收来自计算节点的采样任务，对每个人，开启新的线程进行采样并发回。

如上所述内容均在一个图挖掘任务计算周期内循环执行。当核心节点判断此时的估计结果满足用户给定的误差和置信度条件时，返回并通知其他节点终止任务。

## SamGraph使用说明

### 数据集的使用与预处理

SamGraph使用的是图数据集，一般来说，数据集以边为组织结构单位，即文本文件中的每一行为两个整型数，代表了一条边。SamGraph使用了多个默认的标准数据集，例如Wiki-Vote, Youtube, Patents等。可利用位于 `datasets` 文件夹下的下载脚本下载。

对于下载好的原始数据集，需使用 `split.py` 对其进行分片预处理。它的使用方法是

```bash
python split.py -n [NUMBER OF SLICES] -t [TARGET GRAPH]
```

即提供图分片个数（存储节点的个数）和目标图数据集，对于默认数据集，`TARGET GRAPH` 使用如下简写即可

| 名称         | 简写 |
| ------------ | ---- |
| Wiki-Vote    | wk   |
| Youtube      | yt   |
| Patents      | pt   |
| Live-Journal | lj   |
| Twitter      | tw   |
| Friendster   | fr   |

否则，需要提供目标数据集路径。

预处理后的数据集默认存放于当前路径中的数据集名称路径下，名称分别为0, 1, ..., n-1。若需要进行多机环境，可使用共享文件系统或手动移动到各个机器中。

### 编译与运行

建议使用较新的GCC以及OpenMPI或MPICH，以及pthreads。

使用 `sampling` 文件夹下的 `Makefile` 进行编译。

运行时使用 `mpirun` 或 `mpiexec` 命令，执行 `main` 程序。指定进程数，通过host文件指定运行的集群和进程映射关系。需要注意的是，0号进程为核心节点，1至`COMP_INSTANCES` 号（计算进程数）进程为计算节点，`COMP_INSTANCES+1` 至 `COMP_INSTANCES+STOR_INSTANCES` 号（计算节点数+存储节点数）进程为存储节点。请保证向MPI提供的总进程数值等于核心节点数（1）+计算节点数+存储节点数

提供给 `main` 程序的参数分别为：

| 参数           | 内容         |
| -------------- | ------------ |
| COMP_INSTANCES | 计算节点个数 |
| STOR_INSTANCES | 存储节点个数 |
| GRAPH_DIR      | 图所在路径   |
| NUM_VERTEX     | 顶点数       |
| NUM_SAMPLING   | 采样顶点数   |
| SAMPLE_TASK    | 图挖掘任务   |

对于不同的存储节点，依次读图所在路径下的名称为0, 1, ... 的文件。

对于图挖掘任务，SamGraph提供了经典的挖掘任务的实现，分别为

| 名称       | 图挖掘任务 |
| ---------- | ---------- |
| triangle   | 三角形计数 |
| threechain | 三-链      |
| threemotif | 三-主题    |
| fourchain  | 四-链      |
| fivestar   | 五-星型    |

若用户希望运行其他挖掘任务，请利用`Graph`类提供的`count()`结构，进行用户程序编写。输入为子图，输出为在大图上的估计值。

若用户希望改变误差限和置信度（默认误差限为5%，置信度为95%），请更改 `main.cpp` 中的ALPHA（置信等级）和DELTA（误差限），一般来说，置信等级（p值）为0.01, 0.05, 0.1 等。

运行时，会打出运行时的log（DEBUG模式下），可将其重定向到文件中。

包含估计结果的行形如：

```bash
***************Estimation: 550997.950809***************
```

